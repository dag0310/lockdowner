<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Lockdowner</title>
<meta name="description" content="Nachschauen, wie es mit dem Lockdown vorangeht.">
<meta name="author" content="Daniel Geymayer">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta property="og:image" content="https://apps.geymayer.com/lockdowner/favicon.png">
<link rel="apple-touch-icon" sizes="16x16" href="favicon.png">
<link rel="icon" type="image/png" href="favicon.png" sizes="16x16">
<link rel="shortcut icon" href="favicon.png">
<style>
  * { box-sizing: border-box; touch-action: manipulation; }
  body { font-family: sans-serif; padding: 10px; max-width: 640px; }
  input, select { padding: 5px; }
  button { min-height: 40px; padding: 10px; background-color: yellow; font-size: 16px; font-weight: bold; cursor: pointer; }
  input, select, button { width: 100%; max-width: 400px; border-radius: 5px; }
  h1, h2, h3 { margin-top: 0; }
</style>
<!-- Matomo -->
<script type="text/javascript">
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="https://matomo.geymayer.com/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '8']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->
</head>
<body>
<h1>Lockdowner</h1>
<h3>7-Tage-Inzidenz Österreich</h3>
<select id="pastDays" style="width: 100px; float: right; margin-left: 15px;">
  <option value="45">45 Tage</option>
  <option value="90">90 Tage</option>
  <option value="120">120 Tage</option>
  <option value="">Gesamt</option>
</select>
<p id="latestValue"></p>
<canvas id="chart" width="100%" height="100"></canvas>
<p id="chartText"></p>
<p>Laut MedUni-Wien-Vizerektor Oswald&nbsp;Wagner ist das Ziel die <a href="https://de.wikipedia.org/wiki/Inzidenz_(Epidemiologie)#7-Tage-Inzidenz" target="_blank"><strong>7-Tage-Inzidenz</strong></a> auf <strong>deutlich unter 50</strong> zu senken. Quelle: <a href="https://orf.at/stories/3197576/" target="_blank">orf.at / 16.1.2021</a></p>
<p>Datenquelle: AGES/EMS</p>
<p><a href="https://github.com/dag0310/lockdowner" target="_blank">GitHub-Repository</a></p>
<script src="dayjs.min.js"></script>
<script src="Chart.min.js"></script>
<script>
'use strict'

// TODO: Make these start parameters configurable
const LOCKDOWN_END_DATE = '2021-02-08'
const LOCKDOWN_END_VALUE = 50

const buildEntriesFuture = (entriesPast, lockdownEndDate, lockdownEndValue) => {
  if (entriesPast.length < 1) {
    return [];
  }
  const entriesFuture = JSON.parse(JSON.stringify(entriesPast))
  for (const entry of entriesFuture) {
    entry.sevenDayIncidency = null;
  }
  const mostRecentDay = entriesPast[entriesPast.length - 1];
  const daysDiff = dayjs(lockdownEndDate).diff(mostRecentDay.date, 'day');
  const valueDiff = lockdownEndValue - mostRecentDay.sevenDayIncidency;
  const valuePerDay = valueDiff / daysDiff;
  for (let day = 1; day <= daysDiff; day += 1) {
    entriesFuture.push({
      date: dayjs(mostRecentDay.date).add(day, 'days').format('YYYY-MM-DD'),
      sevenDayIncidency: mostRecentDay.sevenDayIncidency + (valuePerDay * day),
    })
  }
  return entriesFuture;
};

const updateChart = (chart, entries) => {
  const pastDays = parseInt(document.getElementById('pastDays').value, 10);
  const entriesPast = (pastDays != null) ? entries.slice(Math.max(0, entries.length - pastDays)) : entries;
  const entriesFuture = buildEntriesFuture(entriesPast, LOCKDOWN_END_DATE, LOCKDOWN_END_VALUE);

  const latestEntry = entriesPast[entriesPast.length - 1];
  document.getElementById('latestValue').innerHTML = latestEntry ? `Letzter Wert vom ${dayjs(latestEntry.date).format('DD.MM.YYYY')}: <b>${latestEntry.sevenDayIncidency.toFixed()}</b>` : '';

  chart.data.labels = entriesFuture.map(entry => dayjs(entry.date).format('DD.MM.YYYY'));
  chart.data.datasets[0].data = entriesPast.map((entry) => entry.sevenDayIncidency);
  chart.data.datasets[1].data = entriesFuture.map((entry) => entry.sevenDayIncidency);
  chart.update();

  document.getElementById('chartText').innerText = `Die blaue Linie zeigt den benötigten Verlauf an, um den Inzidenz-Wert ${LOCKDOWN_END_VALUE} bis zum ${dayjs(LOCKDOWN_END_DATE).format('DD.MM.YYYY')} zu erreichen.`;
};

(async () => {
  const ctx = document.getElementById('chart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: [
        {
          label: 'Verlauf bis jetzt',
          pointRadius: 0,
          pointHoverRadius: 0,
          hitRadius: 5,
          backgroundColor: 'transparent',
          borderColor: 'red',
          borderWidth: 2,
        },
        {
          label: `notwendiger Verlauf`,
          pointRadius: 0,
          pointHoverRadius: 0,
          hitRadius: 5,
          backgroundColor: 'transparent',
          borderColor: 'blue',
          borderWidth: 2,
          borderDash: [4, 2],
        },
      ],
    },
    options: {
      title: {
        text: '7-Tage-Inzidenz Österreich'
      },
      tooltips: {
        intersect: false,
        callbacks: {
          label: (tooltipItem) => tooltipItem.yLabel.toFixed(0),
        },
      },
      legend: {
        onClick: null,
      },
      scales: {
        xAxes: [{
          scaleLabel: {
            display: true,
            labelString: 'Datum',
          }
        }],
        yAxes: [{
          scaleLabel: {
            display: true,
            labelString: '7-Tage-Inzidenz',
          },
          ticks: {
            beginAtZero: true,
          },
        }],
      },
    },
  });
  const entries = await (await fetch('covid-austria.json')).json();
  document.getElementById('pastDays').addEventListener('input', () => { updateChart(chart, entries); });
  updateChart(chart, entries);
})();
</script>
</body>
</html>